#!/bin/bash

GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

calculate_average() {
    local total=0
    local count=0
    for time in "$@"; do
        total=$(echo "$total + $time" | bc)
        count=$((count + 1))
    done 
    echo "scale=2; ($total / $count) * 1000" | bc
}

get_filesize() {
    local bytes=$(stat -c%s "zig-out/bin/carbon-vm" 2>/dev/null || stat -f%z "zig-out/bin/carbon-vm")
    echo "scale=2; $bytes / (1024 * 1024)" | bc
}

results=()
for mode in "fast" "safe" "small"; do
    printf "\n${GREEN}Testing release mode %s${NC}\n" "$mode"
    zig build --release=$mode >/dev/null 2>&1
    size=$(get_filesize)
    times=()
    for i in {1..50}; do
        printf "  ${BLUE}Run %d: ${NC}" "$i"
        time_output=$( { time ./zig-out/bin/carbon-vm example/main.crbn >/dev/null; } 2>&1 )
        real_time=$(echo "$time_output" | grep real | awk '{print $2}' | sed 's/0m\([0-9.]*\)s/\1/')
        printf "${YELLOW}%.2fms${NC}\n" "$(echo "$real_time * 1000" | bc)"
        times+=($real_time)
    done
    avg=$(calculate_average "${times[@]}")
    results+=("$mode|$avg|$size")
done

printf "\n${GREEN}%-12s %-12s %-12s${NC}\n" "Release Type" "Speed (ms)" "Size (MB)" 
printf "${GREEN}%-12s %-12s %-12s${NC}\n" "------------" "----------" "---------"
for result in "${results[@]}"; do
    IFS='|' read -r mode speed size <<< "$result"
    printf "%-12s %-12s %-12s\n" "$mode" "$speed" "$size"
done